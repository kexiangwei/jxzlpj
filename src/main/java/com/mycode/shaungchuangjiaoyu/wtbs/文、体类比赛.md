--
CREATE TABLE SCJY_WTBS (
	CODE VARCHAR2(16 BYTE) NOT NULL ,
	NAME VARCHAR2(64 BYTE) NULL ,
	HJ_LEVEL1 VARCHAR2(16 BYTE) NULL ,
	HJ_LEVEL2 VARCHAR2(16 BYTE) NULL ,
	GRANT_UNIT VARCHAR2(64 BYTE) NULL ,
	GRANT_DATE DATE NULL ,
	USER_ID VARCHAR2(16 BYTE) NULL ,
	USER_NAME VARCHAR2(16 BYTE) NULL ,
	CREATE_DATE DATE NULL 
);

--
CREATE OR REPLACE VIEW V_SCJY_WTBS AS 
SELECT j.*
,(case when sh.shenhe_code is not null and sh.status !='退回' then '已提交' else '未提交' end ) is_submit
,sh.shenhe_code,sh.batch_num,sh.status
from SCJY_WTBS j 
LEFT JOIN (
	SELECT code,MAX(BATCH_NUM) BATCH_NUM
	from SCJY_WTBS j
	LEFT JOIN COMMON_SHENHE sh on sh.relation_code = j.code
	GROUP BY code
 ) t on t.code = j.code
LEFT JOIN COMMON_SHENHE sh on sh.RELATION_CODE = t.code and sh.BATCH_NUM = t.BATCH_NUM;
--
CREATE OR REPLACE VIEW V_SCJY_WTBS_SHENHE AS 
SELECT j.*
,sh.shenhe_code,sh.batch_num,sh.status
from (
	SELECT code,MAX(BATCH_NUM) BATCH_NUM
	from SCJY_WTBS j
	LEFT JOIN COMMON_SHENHE sh on sh.relation_code = j.code
	where sh.relation_code is not null
	GROUP BY code
 ) t 
LEFT JOIN SCJY_WTBS j on j.code = t.code
LEFT JOIN COMMON_SHENHE sh on sh.RELATION_CODE = t.code and sh.BATCH_NUM = t.BATCH_NUM;