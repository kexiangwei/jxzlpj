--
CREATE OR REPLACE VIEW V_JXYJ_JGLW AS 
SELECT j.*
,(case when sh.shenhe_code is not null and sh.status !='退回' then '已提交' else '未提交' end ) is_submit
,sh.shenhe_code,sh.batch_num,sh.status
from JXYJ_JGLW j 
LEFT JOIN (
	SELECT code,MAX(BATCH_NUM) BATCH_NUM
	from JXYJ_JGLW j
	LEFT JOIN COMMON_SHENHE sh on sh.relation_code = j.code
	GROUP BY code
 ) t on t.code = j.code
LEFT JOIN COMMON_SHENHE sh on sh.RELATION_CODE = t.code and sh.BATCH_NUM = t.BATCH_NUM;
--
CREATE OR REPLACE VIEW V_JXYJ_JGLW_SHENHE AS 
SELECT j.*
,sh.shenhe_code,sh.batch_num,sh.status
from (
	SELECT code,MAX(BATCH_NUM) BATCH_NUM
	from JXYJ_JGLW j
	LEFT JOIN COMMON_SHENHE sh on sh.relation_code = j.code
	where sh.relation_code is not null
	GROUP BY code
 ) t 
LEFT JOIN JXYJ_JGLW j on j.code = t.code
LEFT JOIN COMMON_SHENHE sh on sh.RELATION_CODE = t.code and sh.BATCH_NUM = t.BATCH_NUM