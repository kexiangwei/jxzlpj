CREATE OR REPLACE VIEW V_JXSJ_SKJH AS
SELECT j.code,c.*,MAIN_TEACHER,TEACH_CLASS,dtc.USER_ID,j.USER_name
,(case when shenhe_code is not null and status !='退回' then '已提交' else '未提交' end ) is_submit
,j.shenhe_code,j.batch_num,j.status,j.create_date
FROM DATA_TEACHER_COURSE dtc
LEFT JOIN DATA_COURSE c on c.COURSE_CODE = DTC.COURSE_CODE
LEFT JOIN  (
		SELECT j.*
		,sh.shenhe_code,sh.batch_num,sh.status
		FROM (
			SELECT code,MAX(BATCH_NUM) BATCH_NUM
			from JXSJ_SKJH j
			LEFT JOIN COMMON_SHENHE sh on sh.relation_code = j.code
			GROUP BY code
		) t LEFT JOIN JXSJ_SKJH j on j.code = t.code
		LEFT JOIN COMMON_SHENHE sh on sh.RELATION_CODE = t.code and sh.BATCH_NUM = t.BATCH_NUM
) j on j.COURSE_CODE = dtc.COURSE_CODE and j.user_id = dtc.user_id;
--
CREATE OR REPLACE VIEW V_JXSJ_SKJH_SHENHE AS
SELECT j.code,c.*,MAIN_TEACHER,TEACH_CLASS
,(case when sh.shenhe_code is not null and sh.status !='退回' then '已提交' else '未提交' end ) is_submit
,sh.shenhe_code,sh.batch_num,sh.status,j.USER_ID,j.USER_name,j.create_date
FROM (
		SELECT code,MAX(BATCH_NUM) BATCH_NUM
		from JXSJ_SKJH j
		LEFT JOIN COMMON_SHENHE sh on sh.relation_code = j.code
		where sh.relation_code is not null -- 筛选出已提交的数据
		GROUP BY code
) t
LEFT JOIN JXSJ_SKJH j on j.code = t.code
LEFT JOIN DATA_TEACHER_COURSE dtc  on  dtc.COURSE_CODE = j.COURSE_CODE and dtc.user_id = j.user_id
LEFT JOIN DATA_COURSE c on c.COURSE_CODE = DTC.COURSE_CODE
LEFT JOIN COMMON_SHENHE sh on sh.RELATION_CODE = t.code and sh.BATCH_NUM = t.BATCH_NUM