<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.mycode.jiaoxueyanjiu.jiaogaixiangmu.mapper.JiaoGaiXiangMuMapper">

    <select id="getNotShenHeNum" resultType="int">
        <if test="isZjshAccount !=null"><!-- 此处不能做isZjshAccount !=''的判断，isZjshAccount 值为0 时会被识别为空字符串''-->
            <choose>
                <when test="isZjshAccount == 1">
                    SELECT sum(case when ZJ.CREATE_DATE is null then 1 else 0 end)
                    from COMMON_SHENHE_ITEM it LEFT JOIN JXYJ_JGXM_ZJSH zj on zj.XM_CODE = IT.RELATION_CODE and ZJ.BATCH_NUM = IT.BATCH_NUM and ZJ.USER_ID = #{shenHeUserId}
                    where IT.SHENHE_TYPE = '初审' and IT.STATUS = '通过'
                </when>
                <otherwise>
                    SELECT count(0) from (
                        SELECT j.code,j.batch_num
                            ,count(sn.node_code) total_num
                            ,count(item.node_code) exec_num
                            ,max(case when item.status = '退回' then sn.role_id else 0 end ) is_back
                        from v_JXYJ_JGXM_SHENHE j
                        left join COMMON_SHENHE_NODE sn on sn.shenhe_code = j.shenhe_code
                        left join COMMON_SHENHE_ITEM item on item.relation_code = j.code and item.batch_num = j.batch_num and item.node_code = sn.node_code
                        GROUP BY j.code,j.batch_num
                    )t
                    left join v_JXYJ_JGXM_SHENHE j on j.code = t.code and j.batch_num = t.batch_num
                    left join COMMON_SHENHE_NODE sn on sn.shenhe_code = j.shenhe_code
                    left join sys_user_role ur on ur.role_id = sn.role_id
                    where 1=1
                    and exec_num >= exec_level-1
                    AND 1 != (CASE WHEN sn.exec_level > t.exec_num AND is_back > 0 THEN 1 ELSE 0 END)
                    AND exec_level > exec_num
                    and ur.user_id = #{shenHeUserId}
                </otherwise>
            </choose>
        </if>
    </select>

    <select id="getPageList" resultType="com.mycode.jiaoxueyanjiu.jiaogaixiangmu.domain.JiaoGaiXiangMu">
        <choose>
            <when test="shenHeUserId !=null and shenHeUserId !='' and isZjshAccount == 1"><!-- 校外专家审核列表 -->
                SELECT v.*
                ,(case when ZJ.CREATE_DATE is not null then '已审核' else '未审核' end) shenhe_status
                from  v_JXYJ_JGXM_SHENHE v
                left join COMMON_SHENHE_ITEM it on it.relation_code = v.code and it.batch_num = v.batch_num
                LEFT JOIN JXYJ_JGXM_ZJSH zj on zj.XM_CODE = IT.RELATION_CODE and ZJ.BATCH_NUM = IT.BATCH_NUM and ZJ.user_id = #{shenHeUserId}
                where it.shenhe_type = '初审' and it.STATUS = '通过'
                <if test="shenheStatus != null and shenheStatus != ''">
                    <choose>
                        <when test="shenheStatus == '已审核'">
                            and ZJ.xm_code is not null
                        </when>
                        <when test="shenheStatus == '未审核'">
                            and ZJ.xm_code is null
                        </when>
                    </choose>
                </if>
                <include refid="queryCondition"/>
            </when>
            <when test="shenHeUserId !=null and shenHeUserId !=''"><!-- 审核列表 -->
                SELECT v.*
                ,(case when exec_num >= exec_level then '已审核' else '未审核' end ) shenhe_status
                ,(case when exec_num >= exec_level then '已审核' else '未审核' end ) shenhe_status_first
                ,(case when exec_num > exec_level then '已审核'
                        when exec_num = exec_level and isZjshAll =1 then '未审核' else '待审核' end ) shenhe_status_final
                from (
                    SELECT v.code,v.batch_num
                        ,count(sn.node_code) total_num
                        ,count(item.node_code) exec_num
                        ,max(case when item.status = '退回' then sn.role_id else 0 end ) is_back
                        ,max(NVL(isZjshAll, 0)) isZjshAll
                    from v_JXYJ_JGXM_SHENHE v
                    left join COMMON_SHENHE_NODE sn on sn.shenhe_code = v.shenhe_code
                    left join COMMON_SHENHE_ITEM item on item.relation_code = v.code and item.batch_num = v.batch_num and item.node_code = sn.node_code
                    LEFT JOIN (
                        SELECT xm_code,BATCH_NUM
                        ,(case when count(0) = (SELECT count(0) FROM SYS_USER_ROLE where role_id = 7) then 1 else 0 end) isZjshAll
                        from JXYJ_JGXM_ZJSH
                        GROUP BY xm_code,BATCH_NUM
                    ) zj on zj.xm_code = v.code and zj.batch_num = v.batch_num
                    GROUP BY v.code,v.batch_num
                )t left join v_JXYJ_JGXM_SHENHE v on v.code = t.code and v.batch_num = t.batch_num
                left join COMMON_SHENHE_NODE sn on sn.shenhe_code = v.shenhe_code
                left join sys_user_role ur on ur.role_id = sn.role_id
                <where>1=1
                    and exec_num >= exec_level-1
                    AND 1 != (CASE WHEN sn.exec_level > t.exec_num AND is_back > 0 THEN 1 ELSE 0 END)
                    and ur.user_id = #{shenHeUserId}
                    <if test="shenheStatus != null and shenheStatus != ''">
                        <choose>
                            <when test="shenheStatus == '已审核'">
                                and exec_num >= exec_level
                            </when>
                            <when test="shenheStatus == '未审核'">
                                and exec_level > exec_num
                            </when>
                        </choose>
                    </if>
                    <include refid="queryCondition"/>
                </where>
                ORDER BY shenhe_status DESC
            </when>
            <otherwise>
                SELECT v.*
                from V_JXYJ_JGXM v
                <where>1=1
                    <choose>
                        <when test="status != null and status != '' and status == '待审核'">
                            and shenhe_code is null
                        </when>
                        <when test="status != null and status != ''">
                            and status = #{status}
                        </when>
                    </choose>
                    <include refid="queryCondition"/>
                </where>
            </otherwise>
        </choose>
    </select>
    <sql id="queryCondition">
        <if test="userId != null and userId != '' and userId != 999999">
            and v.user_id = #{userId}
        </if>
        <if test="userName != null and userName != ''">
            and v.user_name = #{userName}
        </if>
        <if test="xmName != null and xmName != ''">
            and xm_name like concat(concat('%',#{xmName}),'%')
        </if>
        <if test="xmType != null and xmType != ''">
            and xm_type = #{xmType}
        </if>
        <if test="leader != null and leader != ''">
            and leader = #{leader}
        </if>
    </sql>

    <insert id="insert">
          insert into JXYJ_JGXM
          (code,xm_name,xm_type,leader,leader_id,title,college_or_dept,major,main_teach_work,main_teach_achievement
          ,current_and_background,question_and_target,expect_and_result,plan_and_process,user_id,user_name,create_date)
          values
          (#{code},#{xmName},#{xmType},#{leader},#{leaderId},#{title},#{collegeOrDept},#{major},#{mainTeachWork,jdbcType=VARCHAR},#{mainTeachAchievement,jdbcType=VARCHAR}
          ,#{currentAndBackground,jdbcType=VARCHAR},#{questionAndTarget,jdbcType=VARCHAR},#{expectAndResult,jdbcType=VARCHAR},#{planAndProcess,jdbcType=VARCHAR}
          ,#{userId},#{userName},sysdate)
    </insert>

    <update id="update">
        update JXYJ_JGXM
        <set>
            <if test="xmName != null and xmName != ''">
                xm_name = #{xmName}
            </if>
            <if test="xmType != null and xmType != ''">
                , xm_type = #{xmType}
            </if>
            <if test="leader != null and leader != ''">
                , leader = #{leader}
            </if>
            <if test="leaderId != null and leaderId != ''">
                , leader_id = #{leaderId}
            </if>
            <if test="title !=null and title !=''">
                , title = #{title}
            </if>
            <if test="collegeOrDept !=null and collegeOrDept !=''">
                , college_or_dept = #{collegeOrDept}
            </if>
            <if test="major !=null and major !=''">
                , major = #{major}
            </if>
            <if test="mainTeachWork !=null and mainTeachWork !=''">
                , main_teach_work = #{mainTeachWork}
            </if>
            <if test="mainTeachAchievement !=null and mainTeachAchievement !=''">
                , main_teach_achievement = #{mainTeachAchievement}
            </if>
            <if test="currentAndBackground !=null and currentAndBackground !=''">
                , current_and_background = #{currentAndBackground}
            </if>
            <if test="questionAndTarget !=null and questionAndTarget !=''">
                , question_and_target = #{questionAndTarget}
            </if>
            <if test="expectAndResult !=null and expectAndResult !=''">
                , expect_and_result = #{expectAndResult}
            </if>
            <if test="planAndProcess !=null and planAndProcess !=''">
                , plan_and_process = #{planAndProcess}
            </if>
        </set>
        where code = #{code}
    </update>

    <delete id="delete">
        delete from JXYJ_JGXM where code = #{code}
    </delete>


    <select id="getShenheNode" resultType="com.mycode.common.shenhe.domain.ShenHeNode">
        SELECT sn.*
        from v_JXYJ_JGXM_SHENHE j
        LEFT JOIN COMMON_SHENHE_NODE sn ON sn.shenhe_code = j.shenhe_code
        LEFT JOIN sys_user_role ur ON ur.role_id = sn.role_id
        where code = #{relationCode} and ur.user_id = #{userId}
    </select>

    <select id="isShenhePass" resultType="int">
        SELECT (case when total_num = exec_num then 1 else 0 end) isPass
        from (
            SELECT j.code,j.batch_num
            ,count(sn.node_code) total_num
            ,count(item.node_code) exec_num
            from v_JXYJ_JGXM_SHENHE j
            left join COMMON_SHENHE_NODE sn on sn.shenhe_code = j.shenhe_code
            left join COMMON_SHENHE_ITEM item on item.relation_code = j.code and item.batch_num = j.batch_num and item.node_code = sn.node_code
            WHERE j.code = #{relationCode} and j.batch_num = #{batchNum}
            GROUP BY j.code,j.batch_num
        )t
    </select>


    <select id="isZjshAll" resultType="java.lang.Integer">
        SELECT case when count(ZJSH.USER_ID) = count(ZJ.USER_ID) then 1 else 0 end as isZjshAll
        FROM (SELECT * FROM SYS_USER_ROLE where role_id = 7) zj
        LEFT JOIN (SELECT * FROM JXYJ_JGXM_ZJSH where XM_CODE = #{relationCode} AND BATCH_NUM = #{batchNum}) zjsh on ZJSH.USER_ID = ZJ.USER_ID
    </select>
    <insert id="toZjShenhe">
        INSERT INTO JXYJ_JGXM_ZJSH
        (XM_CODE,BATCH_NUM,STATUS,OPINION,USER_ID,USER_NAME,CREATE_DATE)
        VALUES
        (#{relationCode},#{batchNum},#{status},#{opinion},#{userId},#{userName},sysdate)
    </insert>

</mapper>